name: Daily ReLSPosed â†’ Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  send-builds:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # ---------------------------------------
      # Get latest run id + dates
      # ---------------------------------------
      - name: Get run info
        run: |
          DATA=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/workflows/core.yml/runs)

          RUN_ID=$(echo "$DATA" | jq -r '.workflow_runs[] | select(.conclusion=="success") | .id' | head -n1)
          RUN_DATE=$(echo "$DATA" | jq -r '.workflow_runs[] | select(.conclusion=="success") | .created_at' | head -n1)
          BOT_DATE=$(date "+%Y-%m-%d %H:%M UTC")

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "RUN_DATE=$RUN_DATE" >> $GITHUB_ENV
          echo "BOT_DATE=$BOT_DATE" >> $GITHUB_ENV

      # ---------------------------------------
      # Download debug + release only
      # ---------------------------------------
      - name: Download artifacts
        run: |
          mkdir downloads

          curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts \
            | jq -r '.artifacts[] | "\(.name)|\(.archive_download_url)"' > list.txt

          while IFS="|" read NAME URL; do
            if [[ "$NAME" == *debug* || "$NAME" == *release* ]]; then
              curl -L \
                -H "Authorization: Bearer ${{ github.token }}" \
                "$URL" \
                -o "downloads/$NAME.zip"
            fi
          done < list.txt

      # ---------------------------------------
      # Send both files in one Telegram message
      # ---------------------------------------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          DEBUG=$(ls downloads/*debug*.zip)
          RELEASE=$(ls downloads/*release*.zip)

          DEBUG_NAME=$(basename "$DEBUG")
          RELEASE_NAME=$(basename "$RELEASE")

          TEXT="$DEBUG_NAME | $RELEASE_NAME | release: $RUN_DATE | bot: $BOT_DATE | by Myst-25 https://github.com/myst-25"

          MEDIA=$(jq -n \
            --arg t "$TEXT" \
            '[{"type":"document","media":"attach://file1","caption":$t},
              {"type":"document","media":"attach://file2"}]')

          curl -sS -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMediaGroup" \
            -F chat_id="-1002868007272" \
            -F message_thread_id="384" \
            -F media="$MEDIA" \
            -F file1=@"$DEBUG" \
            -F file2=@"$RELEASE"
