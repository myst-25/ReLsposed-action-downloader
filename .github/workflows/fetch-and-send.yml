name: Daily ReLSPosed â†’ Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # 12:00 AM UTC daily

jobs:
  send-build:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------
      # Install tools
      # ------------------------------------------------
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl unzip zip

      # ------------------------------------------------
      # Get latest successful run from core.yml only
      # ------------------------------------------------
      - name: Get latest run id
        run: |
          RUN_ID=$(curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/workflows/core.yml/runs \
            | jq -r '.workflow_runs[] | select(.conclusion=="success") | .id' \
            | head -n1)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run: $RUN_ID"

      # ------------------------------------------------
      # Get artifact URLs
      # ------------------------------------------------
      - name: Get artifact URLs
        run: |
          curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts \
            | jq -r '.artifacts[].archive_download_url' > urls.txt

          echo "Artifacts:"
          cat urls.txt

      # ------------------------------------------------
      # Download + extract artifacts
      # ------------------------------------------------
      - name: Download and extract
        run: |
          mkdir extracted

          i=1
          while read url; do
            echo "Downloading artifact $i"

            curl -L \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "Accept: application/vnd.github+json" \
              "$url" \
              -o artifact_$i.zip

            unzip -o artifact_$i.zip -d extracted
            i=$((i+1))
          done < urls.txt

          echo "Extracted files:"
          ls -lh extracted

      # ------------------------------------------------
      # Repack into flashable module zip
      # ------------------------------------------------
      - name: Create flashable zip
        run: |
          cd extracted
          zip -r ../ReLSPosed-latest-build.zip ./*
          cd ..

          echo "Created zip:"
          ls -lh ReLSPosed-latest-build.zip

      # ------------------------------------------------
      # Send to Telegram topic
      # ------------------------------------------------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -v "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
            -F chat_id="-1002868007272" \
            -F message_thread_id="384" \
            -F document=@ReLSPosed-latest-build.zip \
            -F caption="ðŸš€ ReLSPosed Daily Build\nðŸ“¦ Flashable module\nðŸ•› Auto-posted"
