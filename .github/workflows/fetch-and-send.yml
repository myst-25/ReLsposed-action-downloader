name: Daily ReLSPosed â†’ Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # 12:00 AM UTC daily

jobs:
  fetch-and-send:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------
      # Install tools
      # ----------------------------------------
      - name: Install dependencies
        run: sudo apt-get update && sudo apt-get install -y jq curl unzip

      # ----------------------------------------
      # Get latest successful workflow run id
      # ----------------------------------------
      - name: Get latest run id
        run: |
          RUN_ID=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs \
            | jq '.workflow_runs[] | select(.conclusion=="success") | .id' \
            | head -n1)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run: $RUN_ID"

      # ----------------------------------------
      # Get all artifact download URLs
      # ----------------------------------------
      - name: Get artifact URLs
        run: |
          curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts \
            | jq -r '.artifacts[].archive_download_url' > urls.txt

          echo "Artifacts:"
          cat urls.txt

      # ----------------------------------------
      # Download artifacts (requires auth header)
      # ----------------------------------------
      - name: Download artifacts
        run: |
          mkdir downloads
          i=1
          while read url; do
            echo "Downloading artifact $i..."
            curl -L \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "Accept: application/vnd.github+json" \
              "$url" \
              -o "downloads/artifact_$i.zip"
            i=$((i+1))
          done < urls.txt

      # ----------------------------------------
      # Extract all artifacts
      # ----------------------------------------
      - name: Extract artifacts
        run: |
          mkdir extracted
          for f in downloads/*.zip; do
            unzip -o "$f" -d extracted
          done

          echo "Extracted files:"
          ls -R extracted

      # ----------------------------------------
      # Send ALL build zips to Telegram topic
      # ----------------------------------------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          FILES=$(find extracted -name "*.zip")

          echo "Files to send:"
          echo "$FILES"

          for file in $FILES; do
            NAME=$(basename "$file")

            echo "Sending $NAME to Telegram..."

            curl -sS "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
              -F chat_id="-1002868007272" \
              -F message_thread_id="384" \
              -F document=@"$file" \
              -F caption="ðŸš€ ReLSPosed Daily Build\nðŸ“¦ $NAME\nðŸ•› Auto-posted at 12AM"
          done
