name: Daily ReLSPosed â†’ Telegram (Debug + Release)

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # 12:00 AM UTC daily

jobs:
  send-builds:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------------------
      # Install tools
      # ----------------------------------------
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # ----------------------------------------
      # Get latest successful core.yml run
      # ----------------------------------------
      - name: Get latest run id
        run: |
          RUN_ID=$(curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/workflows/core.yml/runs \
            | jq -r '.workflow_runs[] | select(.conclusion=="success") | .id' \
            | head -n1)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run: $RUN_ID"

      # ----------------------------------------
      # Download ONLY debug + release artifacts
      # ----------------------------------------
      - name: Download debug & release artifacts
        run: |
          mkdir downloads

          curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts \
            | jq -r '.artifacts[] | "\(.name)|\(.archive_download_url)"' > list.txt

          while IFS="|" read NAME URL; do
            if [[ "$NAME" == *debug* || "$NAME" == *release* ]]; then
              echo "Downloading $NAME"

              curl -L \
                -H "Authorization: Bearer ${{ github.token }}" \
                -H "Accept: application/vnd.github+json" \
                "$URL" \
                -o "downloads/$NAME.zip"
            fi
          done < list.txt

          echo "Downloaded files:"
          ls -lh downloads

      # ----------------------------------------
      # Send both zips to Telegram topic
      # ----------------------------------------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          for file in downloads/*.zip; do
            NAME=$(basename "$file")

            echo "Sending $NAME"

            curl -sS "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
              -F chat_id="-1002868007272" \
              -F message_thread_id="384" \
              -F document=@"$file" \
              -F caption="ðŸš€ ReLSPosed Build\nðŸ“¦ $NAME\nðŸ•› Daily auto-post"
          done
