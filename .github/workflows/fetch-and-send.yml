name: Daily ReLSPosed â†’ Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # 12:00 AM UTC daily

jobs:
  send-builds:
    runs-on: ubuntu-latest

    steps:
      # -----------------------------
      # Install dependencies
      # -----------------------------
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl unzip

      # -----------------------------
      # Get latest successful run of core.yml ONLY
      # -----------------------------
      - name: Get latest run id
        run: |
          RUN_ID=$(curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/workflows/core.yml/runs \
            | jq -r '.workflow_runs[] | select(.conclusion=="success") | .id' \
            | head -n1)

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "Latest run id: $RUN_ID"

      # -----------------------------
      # Get artifact download URLs
      # -----------------------------
      - name: Get artifact URLs
        run: |
          curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts \
            | jq -r '.artifacts[].archive_download_url' > urls.txt

          echo "Artifact URLs:"
          cat urls.txt

      # -----------------------------
      # Download + extract artifacts
      # -----------------------------
      - name: Download and extract artifacts
        run: |
          mkdir extracted

          i=1
          while read url; do
            echo "Downloading artifact $i"

            curl -L \
              -H "Authorization: Bearer ${{ github.token }}" \
              -H "Accept: application/vnd.github+json" \
              "$url" \
              -o artifact_$i.zip

            unzip -o artifact_$i.zip -d extracted
            i=$((i+1))
          done < urls.txt

          echo "Extracted files:"
          ls -lh extracted

      # -----------------------------
      # Send ONLY debug + release builds
      # -----------------------------
      - name: Send builds to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          for file in extracted/*; do
            NAME=$(basename "$file")

            if [[ "$NAME" == *debug* || "$NAME" == *release* ]]; then
              echo "Sending $NAME to Telegram"

              curl -sS "https://api.telegram.org/bot$BOT_TOKEN/sendDocument" \
                -F chat_id="-1002868007272" \
                -F message_thread_id="384" \
                -F document=@"$file" \
                -F caption="ðŸš€ ReLSPosed Daily Build\nðŸ“¦ $NAME\nðŸ•› Auto-posted"
            fi
          done
