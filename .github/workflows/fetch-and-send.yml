name: ReLSPosed â†’ Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      - name: Get latest run id
        run: |
          DATA=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/workflows/core.yml/runs)
          echo "RUN_ID=$(echo "$DATA" | jq -r '.workflow_runs[0].id')" >> $GITHUB_ENV
          echo "RUN_DATE=$(echo "$DATA" | jq -r '.workflow_runs[0].created_at')" >> $GITHUB_ENV
          echo "BOT_DATE=$(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

      - name: Download debug
        run: |
          URL=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts | jq -r '.artifacts[] | select(.name|contains("debug")) | .archive_download_url')
          curl -L -H "Authorization: Bearer ${{ github.token }}" "$URL" -o debug.zip

      - name: Download release
        run: |
          URL=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts | jq -r '.artifacts[] | select(.name|contains("release")) | .archive_download_url')
          curl -L -H "Authorization: Bearer ${{ github.token }}" "$URL" -o release.zip

      - name: Send debug with caption
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -sS https://api.telegram.org/bot$BOT_TOKEN/sendDocument \
            -F chat_id=-1002868007272 \
            -F message_thread_id=384 \
            -F document=@debug.zip \
            -F caption="debug.zip release.zip release: $RUN_DATE bot: $BOT_DATE by @Myst_25"

      - name: Send release
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -sS https://api.telegram.org/bot$BOT_TOKEN/sendDocument \
            -F chat_id=-1002868007272 \
            -F message_thread_id=384 \
            -F document=@release.zip
