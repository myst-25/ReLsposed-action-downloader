name: Daily ReLSPosed â†’ Telegram

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"   # 12:00 AM UTC daily

jobs:
  send-builds:
    runs-on: ubuntu-latest

    steps:
      # ------------------------------------------------
      # Install tools
      # ------------------------------------------------
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # ------------------------------------------------
      # Get latest run info (id + date)
      # ------------------------------------------------
      - name: Get run info
        run: |
          DATA=$(curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/workflows/core.yml/runs)

          RUN_ID=$(echo "$DATA" | jq -r '.workflow_runs[] | select(.conclusion=="success") | .id' | head -n1)
          RUN_DATE=$(echo "$DATA" | jq -r '.workflow_runs[] | select(.conclusion=="success") | .created_at' | head -n1)

          BOT_DATE=$(date "+%Y-%m-%d %H:%M UTC")

          echo "RUN_ID=$RUN_ID" >> $GITHUB_ENV
          echo "RUN_DATE=$RUN_DATE" >> $GITHUB_ENV
          echo "BOT_DATE=$BOT_DATE" >> $GITHUB_ENV

      # ------------------------------------------------
      # Download ONLY debug + release artifacts
      # ------------------------------------------------
      - name: Download artifacts
        run: |
          mkdir downloads

          curl -s \
            https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts \
            | jq -r '.artifacts[] | "\(.name)|\(.archive_download_url)"' > list.txt

          while IFS="|" read NAME URL; do
            if [[ "$NAME" == *debug* || "$NAME" == *release* ]]; then
              curl -L \
                -H "Authorization: Bearer ${{ github.token }}" \
                -H "Accept: application/vnd.github+json" \
                "$URL" \
                -o "downloads/$NAME.zip"
            fi
          done < list.txt

          ls downloads > names.txt

      # ------------------------------------------------
      # Send BOTH files in ONE message (media group)
      # ------------------------------------------------
      - name: Send to Telegram
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          DEBUG=$(ls downloads/*debug*.zip)
          RELEASE=$(ls downloads/*release*.zip)

          DEBUG_NAME=$(basename "$DEBUG")
          RELEASE_NAME=$(basename "$RELEASE")

          CAPTION="\
\`$DEBUG_NAME\`
\`$RELEASE_NAME\`

release date: $RUN_DATE
bot release date: $BOT_DATE

> **by [Myst-25](https://github.com/myst-25)**"

          curl -sS -X POST "https://api.telegram.org/bot$BOT_TOKEN/sendMediaGroup" \
            -F chat_id="-1002868007272" \
            -F message_thread_id="384" \
            -F "media=[{
              \"type\":\"document\",
              \"media\":\"attach://file1\",
              \"caption\":\"$CAPTION\",
              \"parse_mode\":\"MarkdownV2\"
            },{
              \"type\":\"document\",
              \"media\":\"attach://file2\"
            }]" \
            -F file1=@"$DEBUG" \
            -F file2=@"$RELEASE"
