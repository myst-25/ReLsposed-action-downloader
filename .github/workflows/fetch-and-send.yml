name: ReLSPosed â†’ Telegram + Release

on:
  workflow_dispatch:
  schedule:
    - cron: "0 0 * * *"

permissions:
  contents: write   # REQUIRED for releases

jobs:
  send:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # Install tools
      # ---------------------------------------
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # ---------------------------------------
      # Get latest run info
      # ---------------------------------------
      - name: Get run info
        run: |
          DATA=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/workflows/core.yml/runs)

          echo "RUN_ID=$(echo "$DATA" | jq -r '.workflow_runs[0].id')" >> $GITHUB_ENV
          echo "RUN_DATE=$(echo "$DATA" | jq -r '.workflow_runs[0].created_at')" >> $GITHUB_ENV
          echo "BOT_DATE=$(date '+%Y-%m-%d %H:%M UTC')" >> $GITHUB_ENV

      # ---------------------------------------
      # Download debug artifact
      # ---------------------------------------
      - name: Download debug
        run: |
          NAME=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts | jq -r '.artifacts[] | select(.name|contains("debug")) | .name')
          URL=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts | jq -r '.artifacts[] | select(.name|contains("debug")) | .archive_download_url')

          curl -L -H "Authorization: Bearer ${{ github.token }}" "$URL" -o "$NAME.zip"
          echo "DEBUG_FILE=$NAME.zip" >> $GITHUB_ENV

      # ---------------------------------------
      # Download release artifact
      # ---------------------------------------
      - name: Download release
        run: |
          NAME=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts | jq -r '.artifacts[] | select(.name|contains("release")) | .name')
          URL=$(curl -s https://api.github.com/repos/ThePedroo/ReLSPosed/actions/runs/$RUN_ID/artifacts | jq -r '.artifacts[] | select(.name|contains("release")) | .archive_download_url')

          curl -L -H "Authorization: Bearer ${{ github.token }}" "$URL" -o "$NAME.zip"
          echo "RELEASE_FILE=$NAME.zip" >> $GITHUB_ENV

      # ---------------------------------------
      # Send debug to Telegram
      # ---------------------------------------
      - name: Send debug
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -sS https://api.telegram.org/bot$BOT_TOKEN/sendDocument \
            -F chat_id=-1002868007272 \
            -F message_thread_id=384 \
            -F document=@"$DEBUG_FILE" \
            -F caption=$"$DEBUG_FILE"$'\n\nrelease date: '"$RUN_DATE"$'\nbot release date: '"$BOT_DATE"$'\n\nby @Myst_25'

      # ---------------------------------------
      # Send release to Telegram
      # ---------------------------------------
      - name: Send release
        env:
          BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
        run: |
          curl -sS https://api.telegram.org/bot$BOT_TOKEN/sendDocument \
            -F chat_id=-1002868007272 \
            -F message_thread_id=384 \
            -F document=@"$RELEASE_FILE" \
            -F caption=$"$RELEASE_FILE"$'\n\nrelease date: '"$RUN_DATE"$'\nbot release date: '"$BOT_DATE"$'\n\nby @Myst_25'

      # ---------------------------------------
      # Upload SAME files to GitHub Release
      # ---------------------------------------
      - name: Create / Update GitHub Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: latest-build
          name: Latest ReLSPosed Build
          body: |
            Debug: ${{ env.DEBUG_FILE }}
            Release: ${{ env.RELEASE_FILE }}

            release date: ${{ env.RUN_DATE }}
            bot release date: ${{ env.BOT_DATE }}

            by @Myst_25
          files: |
            ${{ env.DEBUG_FILE }}
            ${{ env.RELEASE_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
