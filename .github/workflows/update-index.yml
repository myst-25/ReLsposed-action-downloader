name: Update index.html download links

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest

    steps:
      # ----------------------------
      # Checkout repo
      # ----------------------------
      - uses: actions/checkout@v4

      # ----------------------------
      # Install jq
      # ----------------------------
      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # ----------------------------
      # Fetch latest release asset URLs
      # ----------------------------
      - name: Get latest asset links
        run: |
          DATA=$(curl -s \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/latest-build)

          DEBUG_URL=$(echo "$DATA" | jq -r '.assets[] | select(.name|contains("debug")) | .browser_download_url')
          RELEASE_URL=$(echo "$DATA" | jq -r '.assets[] | select(.name|contains("release")) | .browser_download_url')

          echo "DEBUG_URL=$DEBUG_URL" >> $GITHUB_ENV
          echo "RELEASE_URL=$RELEASE_URL" >> $GITHUB_ENV

          echo "Debug: $DEBUG_URL"
          echo "Release: $RELEASE_URL"

      # ----------------------------
      # Replace links inside index.html
      # ----------------------------
      - name: Update index.html
        run: |
          sed -i "s|href=\".*release.*zip\"|href=\"$RELEASE_URL\"|" index.html
          sed -i "s|href=\".*debug.*zip\"|href=\"$DEBUG_URL\"|" index.html

          echo "Updated links:"
          grep href index.html

      # ----------------------------
      # Commit & push if changed
      # ----------------------------
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add index.html
          git commit -m "auto: update download links to latest build" || echo "No changes to commit"
          git push
