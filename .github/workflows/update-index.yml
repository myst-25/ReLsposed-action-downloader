name: Update index.html download links

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-index:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Install tools
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # ---------------------------------------
      # Fetch release assets
      # ---------------------------------------
      - name: Get latest asset links
        run: |
          DATA=$(curl -s \
            https://api.github.com/repos/${{ github.repository }}/releases/tags/latest-build)

          DEBUG_URL=$(echo "$DATA" | jq -r '.assets[] | select(.name|contains("debug")) | .browser_download_url')
          RELEASE_URL=$(echo "$DATA" | jq -r '.assets[] | select(.name|contains("release")) | .browser_download_url')

          RELEASE_NAME=$(basename "$RELEASE_URL")

          # extract version (between ReLSPosed- and -zygisk)
          VERSION=$(echo "$RELEASE_NAME" | sed -E 's/ReLSPosed-(.*)-zygisk.*/\1/')

          echo "DEBUG_URL=$DEBUG_URL" >> $GITHUB_ENV
          echo "RELEASE_URL=$RELEASE_URL" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

      # ---------------------------------------
      # Update index.html
      # ---------------------------------------
      - name: Update links + version text
        run: |
          # update download links
          sed -i "s|href=\".*release.*zip\"|href=\"$RELEASE_URL\"|" index.html
          sed -i "s|href=\".*debug.*zip\"|href=\"$DEBUG_URL\"|" index.html

          # update version text
          sed -i "s|Latest build:.*|Latest build: $VERSION|" index.html

      # ---------------------------------------
      # Commit & push
      # ---------------------------------------
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add index.html
          git commit -m "auto: update download links + build version" || echo "No changes"
          git push

