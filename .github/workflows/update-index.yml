name: Update index.html links + version

on:
  release:
    types: [published]
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      # ---------------------------------------
      # Checkout repo
      # ---------------------------------------
      - uses: actions/checkout@v4

      # ---------------------------------------
      # Install tools
      # ---------------------------------------
      - name: Install jq + curl
        run: sudo apt-get update && sudo apt-get install -y jq curl

      # ---------------------------------------
      # Fetch latest release assets
      # ---------------------------------------
      - name: Get latest asset URLs
        run: |
          DATA=$(curl -s https://api.github.com/repos/${{ github.repository }}/releases/tags/latest-build)

          DEBUG_URL=$(echo "$DATA" | jq -r '.assets[] | select(.name|contains("debug")) | .browser_download_url')
          RELEASE_URL=$(echo "$DATA" | jq -r '.assets[] | select(.name|contains("release")) | .browser_download_url')

          RELEASE_NAME=$(basename "$RELEASE_URL")

          # extract version safely
          VERSION=$(echo "$RELEASE_NAME" | sed -E 's/ReLSPosed-(.*)-zygisk.*/\1/')

          echo "DEBUG_URL=$DEBUG_URL" >> $GITHUB_ENV
          echo "RELEASE_URL=$RELEASE_URL" >> $GITHUB_ENV
          echo "VERSION=$VERSION" >> $GITHUB_ENV

          echo "Debug: $DEBUG_URL"
          echo "Release: $RELEASE_URL"
          echo "Version: $VERSION"

      # ---------------------------------------
      # Update index.html
      # ---------------------------------------
      - name: Update HTML
        run: |
          # update download links
          sed -i "s|href=\".*release.*zip\"|href=\"$RELEASE_URL\"|" index.html
          sed -i "s|href=\".*debug.*zip\"|href=\"$DEBUG_URL\"|" index.html

          # replace build-info div safely (ALWAYS works)
          sed -i 's|<div id="build-info">.*</div>|<div id="build-info">Latest build: '"$VERSION"'</div>|' index.html

          echo "Preview:"
          grep href index.html
          grep build-info index.html

      # ---------------------------------------
      # Commit & push
      # ---------------------------------------
      - name: Commit changes
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          git add index.html
          git commit -m "auto: update download links + version" || echo "No changes to commit"
          git push
